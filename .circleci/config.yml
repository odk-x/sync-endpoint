# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/configuration-reference/#job
jobs:
  # Below is the definition of your job to build and test your app, you can rename and customize it as you want.
  build-and-test:
    
    machine:
      image: ubuntu-2204:2022.04.2
  
    steps:
      # Checkout the code as the first step.
      - checkout
      - run:
          name: Setup java version
          command: |
            sudo apt-get install openjdk-8-jdk
            sudo update-java-alternatives --set java-1.8.0-openjdk-amd64
            java -version

      - run:
          name: Setting the version 
          command: |
            cd odk-rest-interface
            sudo env "PATH=$PATH" mvn clean install -DskipTests

      - run:
          name: Saving docker image as tar file
          command: |
            sudo env "PATH=$PATH" mvn clean install
            docker save -o ./sync-endpoint-docker-swarm/sync-endpoint.tar odk/sync-endpoint:latest

      - persist_to_workspace:
          root: .
          paths:
            - .
      - save_cache:
          key: v1-odk/sync-endpoint
          paths:
            - .
  deploy-jar:
    docker:
      # used docekr image as machine executor was not able to push jar to githubrepo
      - image: circleci/openjdk:8

    steps:
      - restore_cache:
          key: v1-odk/sync-endpoint
      - attach_workspace:
          at: /home/circleci/project
      - run:
          name: Changing the version to required version
          command: |
            GIT_HASH=$(grep 'git.commit.id.abbrev' odk-rest-interface/target/classes/git.properties | cut -d'=' -f2 | tr -d '[:space:]')
            BUILD_TIME=$(grep 'git.build.time' odk-rest-interface/target/classes/git.properties | cut -d'=' -f2 | tr -d '[:space:]' | sed 's/[-:]//g')
            sudo env "PATH=$PATH" mvn versions:set -DnewVersion="1.0.0-${BUILD_TIME}-${GIT_HASH}"
      - run:
          name: Deploying jars to github maven repo 
          command: |
            sudo env "PATH=$PATH" mvn -gs settings.xml -pl '!sync-endpoint-war,!sync-endpoint-docker-swarm,!sync-endpoint-docker-test,!postgres-test,!mysql-test,!sync-endpoint-common-dependencies' clean deploy -DskipTests -X


  deploy-image:
    machine:
      image: ubuntu-2204:2022.04.2
    
    steps:
      - restore_cache:
          key: v1-odk/sync-endpoint
      - attach_workspace:
          at: /home/circleci/project
      - run:
          name: Setting up ghcr repo
          command: |
            export CR_PAT=$GITHUB_TOKEN
            echo $CR_PAT | docker login ghcr.io -u odk-x-bot --password-stdin
            docker load -i ./sync-endpoint-docker-swarm/sync-endpoint.tar
      - run:
          name: Pushing the image to GHCR
          command: |
            docker tag odk/sync-endpoint:latest ghcr.io/odk-x/sync-endpoint:latest
            docker push ghcr.io/odk-x/sync-endpoint:latest

 

# Invoke jobs via workflows
# See: https://circleci.com/docs/configuration-reference/#workflows
workflows:
  Build-Test-Deploy: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build-and-test
      - deploy-jar:
          requires:
            - build-and-test
      - deploy-image:
          requires:
          - build-and-test
 